"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{"default":t}}Object.defineProperty(exports,"__esModule",{value:!0});var _DOMUtil=require("apollo-utils/DOMUtil"),_DOMUtil2=_interopRequireDefault(_DOMUtil),_MathUtil=require("apollo-utils/MathUtil"),_MathUtil2=_interopRequireDefault(_MathUtil),_Keyframe=require("../Keyframe"),_Keyframe2=_interopRequireDefault(_Keyframe),SVG={animate:function(t,e,r){var i,n,a,s=e.length;for(i=0;i<s;++i){var o=e[i];for(a=o.keys.length,n=0;n<a;++n){var h=o.keys[n],u=[h.value],l=h.target,d=h.start,f=h.duration,g=h.x0,c=h.y0,p=h.x1,b=h.y1,v=[g,c,p,b],k=void 0;switch(o.name){case"dash":k=new _Keyframe2["default"](t,"strokeDash",l,f,d,v,u,(void 0),(void 0));break;case"gap":k=new _Keyframe2["default"](t,"strokeGap",l,f,d,v,u,(void 0),(void 0));break;case"offset":k=new _Keyframe2["default"](t,"strokeOffset",l,f,d,v,u,(void 0),(void 0));break;case"width":k=new _Keyframe2["default"](t,"strokeWidth",l,f,d,v,u,(void 0),(void 0))}void 0!==k&&(k.easeType=h.type,r.addKeyframe(k))}}},morph:function(t,e,r,i){var n,a,s,o,h=this;for(a=e.length,n=0;n<a;++n){var u=e[n];o=u.keys.length;var l=function(){d=u.keys[s],f=d.start,g=d.duration,c=[d.x0,d.y0,d.x1,d.y1];var e={index:s,value:0,total:d.verticesValue.length,vertsValue:d.verticesValue,vertsTarget:d.verticesTarget,tanInValue:d.inTangentsValue,tanInTarget:d.inTangentsTarget,tanOutValue:d.outTangentsValue,tanOutTarget:d.outTangentsTarget};p=new _Keyframe2["default"](e,"value",1,g,f,c,(void 0),(void 0),function(i,n){for(var a={vertices:[],inTangents:[],outTangents:[]},s=0;s<e.total;++s){var o=s+1;if(closed)o%=e.total;else if(o>=e.total)break;a.vertices.push([_MathUtil2["default"].lerp(n,e.vertsValue[o][0],e.vertsTarget[o][0]),_MathUtil2["default"].lerp(n,e.vertsValue[o][1],e.vertsTarget[o][1])]),a.inTangents.push([_MathUtil2["default"].lerp(n,e.tanInValue[o][0],e.tanInTarget[o][0]),_MathUtil2["default"].lerp(n,e.tanInValue[o][1],e.tanInTarget[o][1])]),a.outTangents.push([_MathUtil2["default"].lerp(n,e.tanOutValue[o][0],e.tanOutTarget[o][0]),_MathUtil2["default"].lerp(n,e.tanOutValue[o][1],e.tanOutTarget[o][1])])}var u=h.getMaxBorder(r),l=h.bezierToPath(a,void 0,u,u);t.setAttribute("d",l),h.determineBounds(t,a,u)}),p.easeType=d.type,i.addKeyframe(p)};for(s=0;s<o;++s){var d,f,g,c,p;l()}}},create:function(){var t=window.document.createElementNS("http://www.w3.org/2000/svg","svg");return t},addPath:function(t,e,r,i){var n=document.createElementNS("http://www.w3.org/2000/svg","path");t.appendChild(n)},applyMasks:function(t,e){if(e.length>0){var r="url(#"+e.join(" ")+")";t.setAttribute("clip-path",r)}},createMasks:function(t,e){var r=[];if(void 0!==e.masks){var i,n=e.masks.length;for(i=0;i<n;++i){var a=e.masks[i],s=this.bezierToPath(a,!0),o=this.getDefs(t);void 0===o&&(o=document.createElementNS("http://www.w3.org/2000/svg","defs"),t.appendChild(o));var h=document.createElementNS("http://www.w3.org/2000/svg","clipPath");h.id=a.name,o.appendChild(h),r.push(a.name);var u=document.createElementNS("http://www.w3.org/2000/svg","path");u.setAttribute("d",s),h.appendChild(u)}}return r},circle:function(t,e,r,i){var n=document.createElementNS("http://www.w3.org/2000/svg","circle"),a=this.getMaxBorder(e);if(this.setup(n,e),n.x=t.x+a,n.y=t.y+a,n.radius=t.width,e.timeline.length>0&&void 0!==i&&this.animate(n,e.timeline,i),void 0!==r){var s=t.x+t.width+2*a,o=t.y+t.height+2*a;s>r.width&&(r.width=s),o>r.height&&(r.height=o)}return n},ellipse:function(t,e,r,i){var n=document.createElementNS("http://www.w3.org/2000/svg","ellipse"),a=this.getMaxBorder(e);if(this.setup(n,e),n.x=t.width/2+t.x+a,n.y=t.height/2+t.y+a,n.width=t.width,n.height=t.height,e.timeline.length>0&&void 0!==i&&this.animate(n,e.timeline,i),void 0!==r){var s=t.x+t.width+2*a,o=t.y+t.height+2*a;s>r.width&&(r.width=s),o>r.height&&(r.height=o)}return n},rectangle:function(t,e,r,i){var n=document.createElementNS("http://www.w3.org/2000/svg","rect"),a=this.getMaxBorder(e);if(this.setup(n,e),n.x=t.x+a/2,n.y=t.y+a/2,n.width=t.width,n.height=t.height,n.roundness=t.roundness,e.timeline.length>0&&void 0!==i&&this.animate(n,e.timeline,i),void 0!==r){var s=t.x+t.width+a,o=t.y+t.height+a;s>r.width&&(r.width=s),o>r.height&&(r.height=o)}return n},determineBounds:function(t,e,r){var i,n=1e8,a=1e8,s=0,o=0,h=e.vertices,u=e.inTangents,l=e.outTangents,d=h.length;for(i=0;i<d;++i){var f=h[i][0]+l[i][0],g=h[i][1]+l[i][1];f<n&&(n=f),g<a&&(a=g)}for(i=0;i<d;++i){var c=h[i][0]+u[i][0]-n,p=h[i][1]+u[i][1]-a;c>s&&(s=c),p>o&&(o=p)}t.x=n+r,t.y=a+r,t.width=s,t.height=o},shape:function(t,e,r,i){var n=document.createElementNS("http://www.w3.org/2000/svg","path"),a=this.getMaxBorder(e),s=this.bezierToPath(t,void 0,a,a);if(n.setAttribute("d",s),this.setup(n,e),this.determineBounds(n,t,a),void 0!==i&&(e.timeline.length>0?this.animate(n,e.timeline,i):t.timeline.length>0&&this.morph(n,t.timeline,e,i)),void 0!==r){var o=n.x+n.width+2*a,h=n.y+n.height+2*a;o>r.width&&(r.width=o),h>r.height&&(r.height=h)}return n},setup:function(t,e){this.extend(t),void 0!==e.fill&&(t.fill=e.fill,void 0!==e.fillAlpha&&(t.fillAlpha=e.fillAlpha)),void 0!==e.stroke&&(t.stroke=e.stroke,t.strokeAlpha=e.strokeAlpha,t.strokeCap=e.strokeCap,t.strokeCorner=e.strokeCorner,t.strokeWidth=e.strokeWidth,void 0!==e.strokeDashes&&(t.strokeDash=e.strokeDashes.dash,t.strokeGap=e.strokeDashes.gap,t.strokeOffset=e.strokeDashes.offset))},extend:function(t){var e={fill:"none",fillR:-1,fillG:-1,fillB:-1,fillA:1,stroke:"none",strokeCap:"butt",strokeCorner:"miter",strokeDash:{dash:0,gap:0,offset:0},strokeR:-1,strokeG:-1,strokeB:-1,strokeA:1,strokeWidth:1};if(Object.defineProperty(t,"fill",{get:function(){return e.fill},set:function(t){e.fill=t;var r=_DOMUtil2["default"].cssToHex(e.fill);e.fillR=r[0],e.fillG=r[1],e.fillB=r[2],this.setAttribute("fill",t)}}),Object.defineProperty(t,"fillAlpha",{get:function(){return e.fillAlpha},set:function(t){e.fillAlpha=t,this.setAttribute("fill-opacity",t)}}),Object.defineProperty(t,"stroke",{get:function(){return e.stroke},set:function(t){e.stroke=t,this.setAttribute("stroke",t)}}),Object.defineProperty(t,"strokeCap",{get:function(){return e.strokeCap},set:function(t){e.strokeCap=t,this.setAttribute("stroke-linecap",t)}}),Object.defineProperty(t,"strokeCorner",{get:function(){return e.strokeCorner},set:function(t){e.strokeCorner=t,this.setAttribute("stroke-linejoin",t)}}),Object.defineProperty(t,"strokeDash",{get:function(){return e.strokeDash.dash},set:function(t){e.strokeDash.dash=t,this.setAttribute("stroke-dasharray",e.strokeDash.dash.toString()+", "+e.strokeDash.gap.toString())}}),Object.defineProperty(t,"strokeGap",{get:function(){return e.strokeDash.gap},set:function(t){e.strokeDash.gap=t,this.setAttribute("stroke-dasharray",e.strokeDash.dash.toString()+", "+e.strokeDash.gap.toString())}}),Object.defineProperty(t,"strokeOffset",{get:function(){return e.strokeDash.offset},set:function(t){e.strokeDash.offset=t,this.setAttribute("stroke-dashoffset",e.strokeDash.offset)}}),Object.defineProperty(t,"strokeAlpha",{get:function(){return e.strokeAlpha},set:function(t){e.strokeAlpha=t,this.setAttribute("stroke-opacity",t)}}),Object.defineProperty(t,"strokeWidth",{get:function(){return e.strokeWidth},set:function(t){e.strokeWidth=t,this.setAttribute("stroke-width",t)}}),t.getAttribute("fill")&&(t.fill=t.getAttribute("fill")),t.getAttribute("fill-opacity")&&(t.fillAlpha=t.getAttribute("fill-opacity")),t.getAttribute("stroke")&&(e.stroke=t.getAttribute("stroke")),t.getAttribute("stroke-linecap")&&(t.strokeCap=t.getAttribute("stroke-linecap")),t.getAttribute("stroke-linejoin")&&(t.strokeCorner=t.getAttribute("stroke-linejoin")),t.getAttribute("stroke-opacity")&&(t.strokeAlpha=Number(t.getAttribute("stroke-opacity"))),t.getAttribute("stroke-width")&&(t.strokeWidth=Number(t.getAttribute("stroke-width"))),t.getAttribute("stroke-dashoffset")&&(t.strokeOffset=Number(t.getAttribute("stroke-dashoffset"))),t.getAttribute("stroke-dasharray")){var r=t.getAttribute("stroke-dasharray").split(", ");t.strokeDash=Number(r[0]),t.strokeGap=Number(r[1])}var i={x:0,y:0,width:0,height:0,roundness:0};switch(t.tagName){case"rect":this.extendRect(t,i);break;case"circle":this.extendCircle(t,i);break;case"ellipse":this.extendEllipse(t,i);break;case"path":this.extendPath(t);break;case"polygon":break;case"polystar":}return t},extendRect:function(t,e){t.getAttribute("x")&&(e.x=Number(t.getAttribute("x"))),t.getAttribute("y")&&(e.y=Number(t.getAttribute("y"))),t.getAttribute("width")&&(e.width=Number(t.getAttribute("width"))),t.getAttribute("height")&&(e.height=Number(t.getAttribute("height"))),t.getAttribute("rx")&&(e.roundness=Number(t.getAttribute("rx"))),Object.defineProperty(t,"x",{get:function(){return e.x},set:function(t){e.x=t,this.setAttribute("x",t)}}),Object.defineProperty(t,"y",{get:function(){return e.x},set:function(t){e.y=t,this.setAttribute("y",t)}}),Object.defineProperty(t,"width",{get:function(){return e.width},set:function(t){e.width=t,this.setAttribute("width",t)}}),Object.defineProperty(t,"height",{get:function(){return e.height},set:function(t){e.height=t,this.setAttribute("height",t)}}),Object.defineProperty(t,"roundness",{get:function(){return e.roundness},set:function(t){e.roundness=t,this.setAttribute("rx",t),this.setAttribute("ry",t)}})},extendCircle:function(t,e){t.getAttribute("cx")&&(e.x=Number(t.getAttribute("x"))),t.getAttribute("cy")&&(e.y=Number(t.getAttribute("y"))),t.getAttribute("r")&&(e.width=e.height=Number(t.getAttribute("r"))),Object.defineProperty(t,"x",{get:function(){return e.x},set:function(t){e.x=t,this.setAttribute("cx",t)}}),Object.defineProperty(t,"y",{get:function(){return e.y},set:function(t){e.y=t,this.setAttribute("cy",t)}}),Object.defineProperty(t,"radius",{get:function(){return e.width},set:function(t){e.width=t,e.height=t,this.setAttribute("r",t)}})},extendEllipse:function(t,e){t.getAttribute("cx")&&(e.x=Number(t.getAttribute("x"))),t.getAttribute("cy")&&(e.y=Number(t.getAttribute("y"))),t.getAttribute("rx")&&(e.width=Number(t.getAttribute("rx"))),t.getAttribute("ry")&&(e.height=Number(t.getAttribute("ry"))),Object.defineProperty(t,"x",{get:function(){return e.x},set:function(t){e.x=t,this.setAttribute("cx",t)}}),Object.defineProperty(t,"y",{get:function(){return e.y},set:function(t){e.y=t,this.setAttribute("cy",t)}}),Object.defineProperty(t,"width",{get:function(){return e.width},set:function(t){e.width=t,this.setAttribute("rx",t/2)}}),Object.defineProperty(t,"height",{get:function(){return e.height},set:function(t){e.height=t,this.setAttribute("ry",t/2)}})},extendPath:function(t){t.straightPath=!0,void 0!==t.getAttribute("d")&&(t.straightPath=!t.getAttribute("d").match(/[C|c|S|s]/g)),t.points=this.pathToPoints(t),t.originals=t.points.slice(),t.segments=_MathUtil2["default"].bezierPathDistance(t.points[0]),t._startPercent=0,t._endPercent=1,t._offsetPercent=0;var e=(Date.now(),this);Object.defineProperty(t,"firstPath",{set:function(t){this.points[0]=t},get:function(){return this.points||(void 0!==this.getAttribute("d")?this.points=e.pathToPoints(this.getAttribute("d"),this.straightPath):this.points=[[]]),this.points[0]}}),Object.defineProperty(t,"startPercent",{get:function(){return this._startPercent},set:function(t){this._startPercent=t,this.updatePath()}}),Object.defineProperty(t,"endPercent",{get:function(){return this._endPercent},set:function(t){this._endPercent=t,this.updatePath()}}),Object.defineProperty(t,"offsetPercent",{get:function(){return this._offsetPercent},set:function(t){this._offsetPercent=t,this.updatePath()}}),t.pointAt=function(e){return _MathUtil2["default"].getPointInPath(t.points[0],t.segments,e)},t.updatePathBetween=function(t,e){this.refPath=this.refPath||this.firstPath,this.firstPath=this.refPath.slice(),this.segments||(this.segments=_MathUtil2["default"].bezierPathDistance(this.points[0]));var r=3,i=this.segments.slice(),n=new Object,a=null,s=_MathUtil2["default"].roundTo(t,r),o=_MathUtil2["default"].roundTo(e,r);if(s>o){var h=_MathUtil2["default"].lerpArray(.5,s,1+o);h=_MathUtil2["default"].roundTo(h-Math.floor(h),r),h>=t&&h<=e&&(a=h)}return(this._startPercent>0||this._endPercent<1)&&(this.firstPath=_MathUtil2["default"].getPathBetween(t,e,this.firstPath,i,n,a)),[this.firstPath]},t.updatePath=function(){var t=this.originals,r=this._offsetPercent,i=this._startPercent+r,n=this._endPercent+r;if((i>1||i<0)&&(i%=1),(n>1||n<0)&&(n%=1),i===n)return void this.setAttribute("d","");if(0===n&&0!==this._endPercent&&(n=1),i>0||n<1)if(i>n){t=this.updatePathBetween(i,1);var a=e.arrayToSVGPath(t,this.straightPath);t=this.updatePathBetween(0,n);var s=e.arrayToSVGPath(t,this.straightPath);this.setAttribute("d",a+s)}else{t=this.updatePathBetween(i,n);var a=e.arrayToSVGPath(t,this.straightPath);this.setAttribute("d",a)}}},getMaxBorder:function(t){var e=void 0!==t.strokeWidth?t.strokeWidth/2:0;if(t.timeline.length>0){var r,i=t.timeline.length;for(r=0;r<i;++r){var n=t.timeline[r];if("width"===n.name){var a,s=n.keys.length;for(a=0;a<s;++a){var o=n.keys[a];o.target>e?e=o.target:o.value>e&&(e=o.value)}return e}}}return e},addCurveForLine:function(t,e,r,i){t.push(_MathUtil2["default"].lerpArray(.01,e,r)),t.push(_MathUtil2["default"].lerpArray(.99,e,r)),t.push(r)},addPointToArray:function(t,e,r,i){var n=[0,0];switch(t.length>0&&(n=t[t.length-1]),r){case"M":t.push([e[0],e[1]]);break;case"c":this.pushNumbersForCurve(t,e,n);break;case"C":this.pushNumbersForCurve(t,e,[0,0]);break;case"h":this.addCurveForLine(t,n,[n[0]+e[0],n[1]],i);break;case"H":this.addCurveForLine(t,n,[e[0],n[1]],i);break;case"v":this.addCurveForLine(t,n,[n[0],n[1]+e[0]],i);break;case"V":this.addCurveForLine(t,n,[n[0],e[0]],i);break;case"l":this.addCurveForLine(t,n,_MathUtil2["default"].add(n,e),i);break;case"L":this.addCurveForLine(t,n,e,i);break;case"S":var a=t[t.length-2],s=_MathUtil2["default"].subArray(n,a),o=_MathUtil2["default"].addArray(n,s);t.push(o),t.push([e[0],e[1]]),t.push([e[2],e[3]]);break;case"s":var a=t[t.length-2],s=_MathUtil2["default"].subArray(n,a),o=_MathUtil2["default"].addArray(n,s);t.push(o),t.push([n[0]+e[0],n[1]+e[1]]),t.push([n[0]+e[2],n[1]+e[3]]);break;default:console.log("ORDER UNKNOWN :",r)}},arrayToSVGString:function(t,e){var r="M"+Math.floor(10*t[0][0])/10+","+(Math.floor(10*t[0][1])/10).toString();if(e)for(var i=1,n=t.length;i<n;i++)r+="L"+Math.floor(10*t[i][0])/10,t[i][1]>=0&&(r+=","),r+=(Math.floor(10*t[i][1])/10).toString();else for(var i=1,n=t.length;i<n;i+=3){r+="C"+Math.floor(10*t[i][0])/10+","+Math.floor(10*t[i][1])/10;for(var a=i+1;a<i+3;a++)r+=","+(Math.floor(10*t[a][0])/10).toString()+","+(Math.floor(10*t[a][1])/10).toString()}return r},arrayToSVGPath:function(t,e){for(var r=[],i=0,n=t.length;i<n;i++)r+=this.arrayToSVGString(t[i],e);return r},arrayToSVGPoints:function(t){for(var e="",r=0,i=t.length;r<i;r++)e+=t[r][0].toString()+","+t[r][1].toString()+" ";return e},bezierToPath:function(t,e,r,i){var n=t.vertices,a=t.inTangents,s=t.outTangents,o=void 0!==r?r:0,h=void 0!==i?i:0,u="M";u+=_MathUtil2["default"].roundTo(n[0][0]+o,1).toString()+","+_MathUtil2["default"].roundTo(n[0][1]+h,1).toString();var l,d,f,g,c,p,b,v,k,y,A,m,w,P,_,M=n.length-1,x=M-1;for(l=0;l<M;++l)d=l+1,f=n[l],g=a[l],c=s[l],p=n[d],b=a[d],v=s[d],k=_MathUtil2["default"].roundTo(f[0]+c[0]+o,1),y=_MathUtil2["default"].roundTo(f[1]+c[1]+h,1),w=_MathUtil2["default"].roundTo(p[0]+o,1),P=_MathUtil2["default"].roundTo(p[1]+h,1),A=_MathUtil2["default"].roundTo(w+b[0],1),m=_MathUtil2["default"].roundTo(P+b[1],1),_=0===g[0]&&0===g[1]&&0===c[0]&&0===c[1],_=_||w===A&&P===m,_?(u+="L",u+=A.toString()+","+m.toString(),l<x&&(u+=",")):(u+="C",u+=k.toString()+","+y.toString()+",",u+=A.toString()+","+m.toString()+",",u+=w.toString()+","+P.toString());return t.closed!==!0&&e!==!0||(l=M,d=0,f=n[l],g=a[l],c=s[l],p=n[d],b=a[d],v=s[d],0===g[0]&&0===g[1]&&0===c[0]&&0===c[1]?(u+="L",u+=_MathUtil2["default"].roundTo(f[0]+o,1).toString()+","+_MathUtil2["default"].roundTo(f[1]+h,1).toString()+",",u+="Z"):(u+="C",u+=_MathUtil2["default"].roundTo(f[0]+c[0]+o,1).toString()+","+_MathUtil2["default"].roundTo(f[1]+c[1]+h,1).toString()+",",u+=_MathUtil2["default"].roundTo(p[0]+b[0]+o,1).toString()+","+_MathUtil2["default"].roundTo(p[1]+b[1]+h,1).toString()+",",u+=_MathUtil2["default"].roundTo(p[0]+o).toString()+","+_MathUtil2["default"].roundTo(p[1]+h).toString())),u},pathToPoints:function(t){var e=t.getAttribute("d"),r=void 0!==e&&!e.match(/[C|c|S|s]/g),i=e.match(/([a-z]|[A-Z])/g),n=e.match(/([^a-zA-Z]+)/g),a=[],s=[];a.push(s);for(var o=0,h=n.length;o<h;o++){var u=n[o],l=u.match(/\-?[0-9|\.]+/g);if(l){for(var d=0,f=l.length;d<f;d++)l[d]=parseFloat(l[d]);this.addPointToArray(s,l,i[o],r)}else s=[],a.push(s)}return a},pointsToArray:function(t){for(var e=t.match(/\-?[0-9|\.]+/g),r=[],i=0,n=e.length;i<n;i+=2)r.push([parseFloat(e[i]),parseFloat(e[i+1])]);return r},pushNumbersForCurve:function(t,e,r){for(var i=0,n=e.length;i<n;i+=2)t.push(_MathUtil2["default"].addArray(r,[e[i],e[i+1]]))},getDefs:function(t){var e,r=t.children.length;for(e=0;e<r;++e){var i=t.children[e];if("defs"===i.tagName)return i}}};exports["default"]=SVG;
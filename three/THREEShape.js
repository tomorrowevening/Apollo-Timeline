"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function organizeList(e){var t=["stroke","fill","transform","trim","repeater"],a=void 0,i=void 0,o=t.length,n=e.length,r=[];for(a=0;a<o;++a){var s=t[a];for(i=0;i<n;++i){var l=e[i].type;if(s===l){r.push(e[i]);break}}}return r}function createPath(e,t){var a=t?window.devicePixelRatio:1,i=[],o=void 0,n=e.vertices.length;for(o=0;o<n;++o)i.push([e.vertices[o].x*a,e.vertices[o].y*a]);return i}var _THREELayer2=require("./THREELayer"),_THREELayer3=_interopRequireDefault(_THREELayer2),StrokeVertex="\n  uniform float thickness;\n  attribute float lineMiter;\n  attribute vec2 lineNormal;\n  attribute vec2 lineDistance; // x = pos, y = total length\n  varying vec2 lineU;\n\n  void main() {\n    lineU = lineDistance;\n    vec3 pointPos = position.xyz + vec3(lineNormal * thickness/2.0 * lineMiter, 0.0);\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( pointPos, 1.0 );\n  }\n",StrokeFragment="\n  varying vec2 lineU;\n\n  uniform vec3 diffuse;\n  uniform float opacity;\n  uniform vec3 dash; // x = dash,  y = gap, z = offset\n  uniform vec3 trim; // x = start, y = end, z = offset\n\n  void main() {\n    float opacityMod = 1.0;\n    \n    // Dash\n    if(dash.x > 0.0 && dash.y > 0.0) {\n      float dashEnd = dash.x + dash.y;\n      float lineUMod = mod(lineU.x + dash.z, dashEnd);\n      opacityMod = 1.0 - smoothstep(dash.x, dash.x + 0.01, lineUMod);\n    }\n    \n    // Trim\n    if(trim.x > 0.0 || trim.y < 1.0) {\n      float a = mod(trim.x + trim.z, 1.0);\n      float b = mod(trim.y + trim.z, 1.0);\n      float per = lineU.x / lineU.y;\n      if(a < b) {\n        if(per < a || per > b) {\n          opacityMod = 0.0;\n        }\n      } else if(a > b) {\n        if(per < a && per > b) {\n          opacityMod = 0.0;\n        }\n      }\n    }\n    \n    if(opacityMod == 0.0) {\n      discard;\n    }\n    gl_FragColor = vec4(diffuse, opacity * opacityMod);\n  }\n";module.exports=function(e){function t(t){return new e.ShaderMaterial({uniforms:{thickness:{type:"f",value:void 0!==t.thickness?t.thickness:4},opacity:{type:"f",value:void 0!==t.opacity?t.opacity:1},diffuse:{type:"c",value:new e.Color(void 0!==t.diffuse?t.diffuse:16777215)},dash:{type:"f",value:void 0!==t.dash?t.dash:new e.Vector3(0,10,0)},trim:{type:"f",value:void 0!==t.trim?t.trim:new e.Vector3(0,1,0)}},vertexShader:StrokeVertex,fragmentShader:StrokeFragment,side:void 0!==t.side?t.side:e.DoubleSide,transparent:void 0===t.transparent||t.transparent})}var a=require("three-line-2d")(e),i=function(i){function o(i,n,r,s){function l(i){var o=void 0,r=i.length,s=void 0,d=void 0,f=void 0,u=void 0;for(o=0;o<r;++o){var v=i[o],m=void 0!==v.paths&&v.paths.length>0;if(m){var p=void 0,y=void 0,M=void 0,T=void 0,_=void 0,b=void 0,g=void 0,w=void 0,E=void 0,k=!0,x={opacity:1,anchor:[0,0,0],position:[0,0,0],rotation:[0,0,0],scale:[1,1,1],timeline:[]};for(f=v.content.length,u=organizeList(v.content),d=0;d<f;++d){var R=u[d];switch(R.type){case"fill":T={alpha:R.value.opacity,color:R.value.color};break;case"stroke":_={alpha:R.value.opacity,color:R.value.color,width:R.value.width*c,dashes:R.value.dashes};break;case"transform":x=R;break;case"trim":w=R;break;case"repeater":E=R}}if(void 0!==_){if(b=new e.Color(_.color[0],_.color[1],_.color[2]),s=new t({diffuse:b.getHex(),opacity:_.alpha,thickness:_.width}),void 0!==_.dashes&&(s.uniforms.dash.value.x=_.dashes.dash*c,s.uniforms.dash.value.y=_.dashes.gap*c,s.uniforms.dash.value.z=_.dashes.offset*c,void 0!==_.dashes.timeline))for(f=_.dashes.timeline.length,d=0;d<f;++d)switch(_.dashes.timeline[d].name){case"dash":_THREELayer3["default"].animate(s.uniforms.dash.value,"x",n,_.dashes.timeline[d],!0);break;case"gap":_THREELayer3["default"].animate(s.uniforms.dash.value,"y",n,_.dashes.timeline[d],!0);break;case"offset":_THREELayer3["default"].animate(s.uniforms.dash.value,"z",n,_.dashes.timeline[d],!0)}if(void 0!==w)for(s.uniforms.trim.value.x=w.value.start,s.uniforms.trim.value.y=w.value.end,s.uniforms.trim.value.z=w.value.offset,f=w.timeline.length,d=0;d<f;++d)switch(w.timeline[d].name){case"start":_THREELayer3["default"].animate(s.uniforms.trim.value,"x",n,w.timeline[d]);break;case"end":_THREELayer3["default"].animate(s.uniforms.trim.value,"y",n,w.timeline[d]);break;case"offset":_THREELayer3["default"].animate(s.uniforms.trim.value,"z",n,w.timeline[d])}}else void 0!==T&&(b=new e.Color(T.color[0],T.color[1],T.color[2]),s=new e.MeshBasicMaterial({color:b,opacity:T.alpha,side:e.DoubleSide,transparent:!0,depthTest:!1}));for(M=new e.Shape,f=v.paths.length,d=0;d<f;++d){var P=void 0,U=void 0,L=void 0,H=void 0,O=void 0,z=void 0,C=void 0,I=void 0,S=void 0,D=v.paths[d];switch(k=!0,D.type){case"ellipse":U=D.x*c,L=D.y*c,H=D.width/2*c,O=D.height/2*c,M.ellipse(U,L,H,O,0,MathU.TWO_PI,!0,Math.PI/2);break;case"rectangle":U=(D.x-D.width/2)*c,L=(D.y-D.height/2)*c,H=D.width*c,O=D.height*c,M.moveTo(U,L),M.lineTo(U+H,L),M.lineTo(U+H,L+O),M.lineTo(U,L+O);break;case"polygon":for(I=D.points,H=D.radius*c,P=MathU.HALF_PI,M.moveTo(Math.cos(P)*H,Math.sin(P)*H),z=1;z<D.points+1;++z)P=z/I*MathU.TWO_PI+MathU.HALF_PI,M.lineTo(Math.cos(P)*H,Math.sin(P)*H);break;case"polystar":for(I=2*D.points,H=D.outRadius*c,O=D.inRadius*c,P=MathU.toRad(D.rotation)+MathU.HALF_PI,M.moveTo(Math.cos(P)*H,Math.sin(P)*H),P=1/I*MathU.TWO_PI+MathU.toRad(D.rotation)+MathU.HALF_PI,M.lineTo(Math.cos(P)*O,Math.sin(P)*O),z=1;z<D.points;++z)P=2*z/I*MathU.TWO_PI+MathU.toRad(D.rotation)+MathU.HALF_PI,M.lineTo(Math.cos(P)*H,Math.sin(P)*H),P=(2*z+1)/I*MathU.TWO_PI+MathU.toRad(D.rotation)+MathU.HALF_PI,M.lineTo(Math.cos(P)*O,Math.sin(P)*O);break;case"shape":for(I=D.vertices.length,S=!1,k=D.closed,M.moveTo(D.vertices[0][0]*c,D.vertices[0][1]*-c),C=0;C<I;++C)if(0!==D.inTangents[C][0]||0!==D.inTangents[C][1]||0!==D.outTangents[C][0]||0!==D.outTangents[C][1]){S=!0;break}if(S)for(C=0;C<I;++C){if(z=C+1,D.closed)z%=I;else if(z>=I)break;M.bezierCurveTo((D.vertices[C][0]+D.outTangents[C][0])*c,(D.vertices[C][1]+D.outTangents[C][1])*-c,(D.vertices[z][0]+D.inTangents[z][0])*c,(D.vertices[z][1]+D.inTangents[z][1])*-c,D.vertices[z][0]*c,D.vertices[z][1]*-c)}else for(C=0;C<I;++C){if(z=C+1,D.closed)z%=I;else if(z>=I)break;M.lineTo(D.vertices[z][0]*c,D.vertices[z][1]*-c)}_THREELayer3["default"].morph(M,D,n,D.closed)}}if(g=new e.Object3D,h.add(g),void 0!==_){var j=M.createPointsGeometry(36),F=createPath(j,!1);p=a(F,{closed:k,distances:void 0!==_.dashes||void 0!==w})}else p=new e.ShapeGeometry(M);y=new e.Mesh(p,s),_THREELayer3["default"].transform(g,y,x,n),g.add(y)}else{var A=new e.Object3D;A.name=v.name,h.add(A),h=A,l(v.content)}}}_classCallCheck(this,o);var d=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,i,n));d.mesh=new e.Object3D,d.item.add(d.mesh);var c=window.devicePixelRatio,h=d.mesh;return l(i.content),_THREELayer3["default"].transform(d.item,d.mesh,i.transform,n),d}return _inherits(o,i),o}(_THREELayer3["default"]);return i};